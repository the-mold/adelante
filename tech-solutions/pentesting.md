# Rules of Engagement (ROE)
Before you start pentest, decide with the client on ROE.
1. Permission: This section of the document gives explicit permission for the engagement to be carried out. This permission is essential to legally protect individuals and organisations for the activities they carry out.
2. Scope: This section of the document will annotate specific targets to which the engagement should apply. For example, the penetration test may only apply to certain servers or applications but not the entire network.
3. Rules: the rules section will define exactly the techniques that are permitted during the engagement. For example, the rules may specifically state that techniques such as phishing attacks are prohibited, but MITM (Man-in-the-Middle) attacks are okay.

# Engagement Stages
1. Information Gathering: This stage involves collecting as much publically accessible information about a target/organisation as possible, for example, OSINT and research.
Note: This does not involve scanning any systems.
2. Enumeration/Scanning: This stage involves discovering applications and services running on the systems. For example, finding a web server that may be potentially vulnerable.
3.Â Exploitation: This stage involves leveraging vulnerabilities discovered on a system or application. This stage can involve the use of public exploits or exploiting application logic.
4. Privilege Escalation: Once you have successfully exploited a system or application (known as a foothold), this stage is the attempt to expand your access to a system. You can escalate horizontally and vertically, where horizontally is accessing another account of the same permission group (i.e. another user), whereas vertically is that of another permission group (i.e. an administrator).
5. Post-exploitation: 
This stage involves a few sub-stages:
5.1. What other hosts can be targeted (pivoting)
5.2. What additional information can we gather from the host now that we are a privileged user
5.3. Covering your tracks
5.4. Reporting

# Frameworks
For web applications the most suitable is OWASP

# Scopes
1. Black-Box Testing: tester is not given any information about the inner workings of the application or service.
2. Grey-Box Testing: most popular for pentesting. The tester will have some limited knowledge of the internal components of the application or piece of software. Still, it will be interacting with the application as if it were a black-box scenario and then using their knowledge of the application to try and resolve issues as they find them.
3. White-Box Testing: tester has the full knowledge of system adn code.

# Report
In the end of engagement, tester makes a report where documents what was done, what was found and how to avoid it.


# CIA triad
CIA is information security model. There are three components and all of them must be secured to guard the data.
## Confidentiality
protection of data from unauthorized access and misuse
## Integrity
information is kept accurate and consistent unless authorized changes are made
## Availability
data must be available and acessible by the user.



# Security Solutions

## Host based
### 1. Antivirus
Malware is detected with methods:
- Signature-based detection
- Heuristic-based detection: code analysis, some strange API calls etc
- Behavior-based detection: what malware does, how many processes starts etc.
Check in Windows if any antivirus is installed:
```
C> wmic /namespace:\\root\securitycenter2 path antivirusproduct
or
PS> Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct
```

### 2. Microsoft Defender
It is standard microsoft antivirus. It is in passive mode, if any third party untivirus is installed.
Check defender status:
```
PS> Get-Service WinDefend
or
PS> Get-MpComputerStatus
```
Check what MS Defender considers as threat on the machine:
```
Get-MpThreat
```

### 3. Firewall
Firewall protect host by allowing traffic only on specific ports. Modern firewalls can also do package inspection and disallow
for example SQL injections.
Check firewall:
```
PS> Get-NetFirewallProfile | Format-Table Name, Enabled
#and then disable firewall:
PS> Set-NetFirewallProfile -Profile Domain, Public, Private -Enabled False
```
You can see firewall rules:
```
Get-NetFirewallRule | select DisplayName, Enabled, Description
```
If you assume that there is firewall, but you are no admin to check it, you can test what ports are open:
```
PS> Test-NetConnection -ComputerName 127.0.0.1 -Port 80
```

### 4. Security Event Logging and Monitoring 
Check all available logs on WindowS:
```
PS> Get-EventLog
```

### 5. Microsoft system monitor(sysmon)
It is not installed by default. It starts gathering logs only after installation.
As red teamer, you want to be quite on the machine. Check if sysmon is installed:
```
PS C:\Users\thm> Get-Process | Where-Object { $_.ProcessName -eq "Sysmon" }
or
PS C:\Users\thm> Get-CimInstance win32_service -Filter "Description = 'System Monitor service'"
# or
PS> Get-Service | where-object {$_.DisplayName -like "*sysm*"}
or
PS C:\Users\thm> reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft-Windows-Sysmon/Operational
```
Then try to search for sysmon config file to know what administrators are monitoring:
```
PS C:\Users\thm> findstr /si '<ProcessCreate onmatch="exclude">' C:\tools\* 
```

### 6. Endpoint Detection and Response (EDR)
EDRs are the next generation of antivirus and detect malicious activities on the host in real-time. Unlike antivirus,
EDR collects data from different sources(malicious files, monitor endpoint, system, and network events), analyses and responds to threats in real time. Data is stored in a database 
for further analysis, detection, and investigation. 
Antivirus looks only for know theats(for example by signature), but EDR tries to identify unknow threats based on analyses.
EDR analyze system data and behavior for making section threats, including:
- Malware, including viruses, trojans, adware, keyloggers
- Exploit chains
- Ransomware
Big vendors: Cylance, Crowdstrike, Symantec, SentinelOne

Check if there is EDR process running:
```
Invoke-EDRChecker
```

## Network Security Solutions
### 1. Network firewalls
Network firewalls inspect untrusted traffic and allow and reject it based on some policies.

### 2. Security Information and Event Management (SIEM)
SIEM solutions work as log data aggregation center, where it collects log files from sensors all over organization.
Provides centralized visibility and analysis of security data from multiple sources, helping organizations detect, analyze, and respond to security threats.
Functions:
- It applies advanced analytics to detect abnormal patterns or behaviors, available in the dashboard with charts and statistics.
- Incident monitoring and security alerts: It monitors the entire network, including connected users, devices, applications, etcetera, and as soon as attacks are detected, it alerts administrators immediately to take appropriate action to mitigate.
- Compliance management and reporting: It generates real-time reports at any time.
- SIEM is capable of detecting advanced and unknown threats using integrated threat intelligence and AI technologies, including Insider threats, security vulnerabilities, phishing attacks, Web attacks, DDoS attacks, data exfiltration, etc.

Vendors: Splunk, LogRhythm NextGen SIEM Platform, SolarWinds Security Event Manager, Datadog Security Monitoring

### 3. Intrusion Detection System and Intrusion Prevention System (NIDS/NIPS)
IDS and IPS read network packets looking for abnormal behaviors and known threats pre-loaded 
into a previous database. The significant difference between both solutions is that the IDS requires human 
interaction or 3rd party software to analyze the data to take action. The IPS is a control system that 
accepts or rejects packets based on policies and rules.

Vendors: Palo Alto Networks, Cisco's Next-Generation, McAfee Network Security Platform (NSP), 
Trend Micro TippingPoint, Suricata
